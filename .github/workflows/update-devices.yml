name: Update Device Specifications

on:
  schedule:
    # Run every Sunday at 6:00 UTC
    - cron: '0 6 * * 0'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-devices:
    runs-on: tart
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
    
    - name: Run device generator
      run: |
        echo "🏭 Running device generator to update device specifications..."
        ./gradlew :device-generator:run

    - name: Build and test with updated devices
      run: |
        echo "🔨 Building and testing with updated device specifications..."
        ./gradlew build test

    - name: Check for changes
      id: git-check
      run: |
        git diff --exit-code || echo "changes=true" >> $GITHUB_OUTPUT
        
    - name: Create Pull Request
      if: steps.git-check.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore(devices): update device specifications
          
          - Update device specifications from latest Android Device Catalog
          - Add new devices and update existing specifications  
          - Automated update via device-generator
        title: 'chore(devices): update device specifications'
        body: |
          ## 📱 Device Specifications Update
          
          This PR contains automated updates to the device specifications generated from the Android Device Catalog.
          
          ### Changes Made
          - Updated device specifications from latest Android Device Catalog data
          - Regenerated manufacturer extension files with PascalCase naming
          - Added new devices where available
          - Updated existing device specifications with latest information
          
          ### Generation Process
          - ✅ Device generator executed successfully
          - ✅ Build validation passed
          - ✅ All tests passing
          - ✅ Device specifications format validated
          - ✅ PascalCase naming conventions applied
          
          ### Device Sources
          The device generator fetches data from:
          - Android Device Catalog maintained by Google Play Store
          - Supports Google Pixel/Nexus devices and third-party manufacturers
          - Generates both main `Devices.kt` and manufacturer extension files
          
          ### Files Updated
          - `library/src/main/kotlin/com/premex/compose/preview/Devices.kt`
          - `library/src/main/kotlin/com/premex/compose/preview/devices/*Devices.kt`
          
          ---
          
          *This is an automated PR created by the device generator workflow.*
          *Please review the changes before merging.*
        branch: update-device-specifications
        delete-branch: true
        base: main
        draft: false
        labels: |
          enhancement
          automated
          devices
          
    - name: Comment on workflow run
      if: steps.git-check.outputs.changes != 'true'
      run: |
        echo "No device specification changes detected. Skipping PR creation."